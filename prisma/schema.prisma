generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  admin
  finance
  clerk
  documentation
  sales
  readOnly
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  password         String
  name             String?
  role             Role              @default(readOnly)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  salaries         Salaries[]
  employeePayments EmployeePayment[]
  packingAmounts   PackingAmount[]
}

model FishVariety {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
}

model FormerLoading {
  id         String   @id @default(uuid())
  fishCode   String
  billNo     String   @unique
  FarmerName String?
  village    String
  date       DateTime
  vehicleId  String   @unique // Foreign key (ONE loading → ONE vehicle)
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id])

  totalTrays    Int   @default(0)
  totalLooseKgs Float @default(0)
  totalTrayKgs  Float @default(0)
  totalKgs      Float @default(0)
  totalPrice    Float @default(0)

  accountNumber String?
  ifsc          String?
  bankName      String?
  bankAddress   String?

  grandTotal Float        @default(0)
  items      FormerItem[]
  createdAt  DateTime     @default(now())
}

model FormerItem {
  id              String        @id @default(uuid())
  formerLoadingId String // ← changed from Int to String
  varietyCode     String
  noTrays         Int
  trayKgs         Float
  loose           Float
  totalKgs        Float
  pricePerKg      Float         @default(0)
  totalPrice      Float         @default(0)
  loading         FormerLoading @relation(fields: [formerLoadingId], references: [id], onDelete: Cascade)

  @@index([formerLoadingId])
}

model AgentLoading {
  id        String   @id @default(uuid())
  fishCode  String
  agentName String
  billNo    String   @unique
  village   String
  date      DateTime
  vehicleId String   @unique // Foreign key (ONE loading → ONE vehicle)
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id])

  // SAME TOTALS AS FARMER — REQUIRED
  totalTrays    Int   @default(0)
  totalLooseKgs Float @default(0)
  totalTrayKgs  Float @default(0)
  totalKgs      Float @default(0)
  totalPrice    Float @default(0)

  accountNumber String?
  ifsc          String?
  bankName      String?
  bankAddress   String?

  grandTotal Float @default(0)

  createdAt DateTime    @default(now())
  items     AgentItem[]
}

model AgentItem {
  id             String @id @default(uuid())
  agentLoadingId String
  varietyCode    String

  noTrays  Int
  trayKgs  Float
  loose    Float
  totalKgs Float

  pricePerKg Float @default(0)
  totalPrice Float @default(0)

  loading AgentLoading @relation(fields: [agentLoadingId], references: [id], onDelete: Cascade)

  @@index([agentLoadingId])
}

model ClientLoading {
  id         String   @id @default(uuid())
  clientName String
  billNo     String   @unique
  date       DateTime
  vehicleId  String   @unique // Foreign key (ONE loading → ONE vehicle)
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id])
  fishCode   String
  village    String

  // SAME TOTALS AS FARMER — REQUIRED

  totalTrays    Int   @default(0)
  totalLooseKgs Float @default(0)
  totalTrayKgs  Float @default(0)
  totalKgs      Float @default(0)
  totalPrice    Float @default(0)
  grandTotal    Float @default(0)

  accountNumber String?
  ifsc          String?
  bankName      String?
  bankAddress   String?

  items          ClientItem[]
  createdAt      DateTime        @default(now())
  clientPayments ClientPayment[]
}

model ClientItem {
  id              String @id @default(uuid())
  clientLoadingId String
  varietyCode     String

  noTrays  Int
  trayKgs  Float
  loose    Float
  totalKgs Float

  pricePerKg Float @default(0)
  totalPrice Float @default(0)

  loading ClientLoading @relation(fields: [clientLoadingId], references: [id], onDelete: Cascade)

  @@index([clientLoadingId])
}

model Salaries {
  id     String   @id @default(cuid())
  userId String
  month  DateTime
  amount Int
  notes  String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model VendorPayment {
  id                String   @id @default(uuid())
  vendorId          String
  vendorName        String
  source            String
  date              DateTime
  amount            Float
  paymentMode       String
  accountNumber     String?
  ifsc              String?
  bankName          String?
  bankAddress       String?
  paymentdetails    String?
  paymentRef        String?
  isInstallment     Boolean  @default(false)
  installments      Int?
  installmentNumber Int?
  createdAt         DateTime @default(now())
  referenceNo       String?

  @@index([vendorId])
  @@index([source])
}

model ClientPayment {
  id            String      @id @default(uuid())
  clientId      String
  clientName    String
  date          DateTime
  amount        Float
  paymentMode   PaymentMode
  reference     String?
  imageUrl      String?
  isInstallment Boolean     @default(false) // NEW
  createdAt     DateTime    @default(now())

  // Relation to ClientLoading (safe even if not migrated yet)
  client ClientLoading? @relation(fields: [clientId], references: [id], onDelete: Restrict)

  @@index([clientId])
  @@index([date])
}

// ! VEHICLE 

enum VehicleOwnership {
  OWN
  RENT
}

enum FuelType {
  DIESEL
  PETROL
  CNG
  ELECTRIC
}

enum VehicleType {
  OWN
  RENT
}

enum PaymentMode {
  AC
  UPI
  CASH
  CHEQUE
}

model VehicleEntry {
  id        String  @id @default(cuid())
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  type VehicleType // OWN or RENT

  trip String
  date DateTime

  // Own vehicle expenses
  diesel   Float? @default(0)
  service  Float? @default(0)
  fastag   Float? @default(0)
  eChallan Float? @default(0)
  tyres    Float? @default(0)

  // Rent-specific fields
  rentAmount  Float?
  paymentMode PaymentMode?

  totalExpense Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vehicleId])
}

model Vehicle {
  id            String           @id @default(cuid())
  vehicleNumber String           @unique
  ownership     VehicleOwnership

  // Basic details
  manufacturer      String?
  model             String?
  yearOfManufacture Int?
  fuelType          FuelType?
  engineNumber      String?   @unique
  chassisNumber     String?   @unique

  // Transport details
  capacityInTons Float?
  bodyType       String?

  // Regulatory documents
  rcValidity      DateTime?
  insuranceExpiry DateTime?
  fitnessExpiry   DateTime?
  pollutionExpiry DateTime?
  permitExpiry    DateTime?
  roadTaxExpiry   DateTime?

  // Driver assignment (NEW)
  assignedDriverId String? @unique
  assignedDriver   Driver? @relation(fields: [assignedDriverId], references: [id])

  // For rent vehicles
  rentalAgency     String?
  rentalRatePerDay Float?

  // Status
  isActive Boolean @default(true)
  remarks  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  farmerLoadings FormerLoading?
  agentLoadings  AgentLoading?
  clientLoadings ClientLoading?

  // 1 Vehicle → Many Trips
  trips VehicleEntry[]
}

model Driver {
  id            String   @id @default(cuid())
  name          String
  phone         String   @unique
  licenseNumber String   @unique
  address       String
  age           Int
  aadharNumber  String   @unique
  createdAt     DateTime @default(now())

  assignedVehicle Vehicle?
}

model EmployeePayment {
  id           String      @id @default(uuid())
  userId       String
  employeeName String
  date         DateTime
  amount       Float
  paymentMode  PaymentMode
  reference    String? // UTR, Cheque No., etc.
  createdAt    DateTime    @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([date])
}

model PackingAmount {
  id             String   @id @default(uuid())
  mode           String // "loading" or "unloading"
  sourceRecordId String? // Optional bill reference
  workers        Int
  temperature    Float
  totalAmount    Float
  createdAt      DateTime @default(now())
  createdById    String?
  createdBy      User?    @relation(fields: [createdById], references: [id])

  @@index([mode])
  @@index([createdAt])
}

model InvoiceCounter {
  id    Int @id @default(1)
  count Int @default(0)
}

model Invoice {
  id            String   @id @default(uuid())
  invoiceNumber String   @unique
  seq           Int
  prefix        String   @default("RS-Fisheries-")
  partyName     String?
  partyAddress  String?
  date          DateTime @default(now())
  items         Json // array of { description, hsn, qty, rate, amount }
  subtotal      Float
  taxAmount     Float
  total         Float
  createdAt     DateTime @default(now())
}
